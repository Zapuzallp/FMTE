{% extends 'base.html' %}
{% load static %}

{% block title %}
Lab Vision Home V-1.0
{% endblock title %}

{% block body %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css">

<div class="container mt-5">
    <h2 class="text-center">ARN Tracking Records</h2><br>
    <form method="GET" action="{% url 'arn_tracking_list' %}" class="mb-4">
        <div class="row">
            <div class="col-md-2">
                <label for="application_no">Application No</label>
                <input type="text" class="form-control" id="application_no" name="application_no" value="{{ request.GET.application_no }}" placeholder="Enter Application No">
            </div>
            <div class="col-md-2">
                <label for="status">Status</label>
                <select class="form-control" id="status_option" name="status">
                    <option value="">All</option>
                    <option value="Pending" {% if request.GET.status == "Pending" %}selected{% endif %}>Pending</option>
                    <option value="Progressing" {% if request.GET.status == "Progressing" %}selected{% endif %}>Progressing</option>
                    <option value="Accepted" {% if request.GET.status == "Accepted" %}selected{% endif %}>Accepted</option>
                    <option value="Rejected" {% if request.GET.status == "Rejected" %}selected{% endif %}>Rejected</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="startdate">Start Date</label>
                <input type="date" class="form-control" id="startdate" name="startdate" value="{{ request.GET.startdate }}">
            </div>
            <div class="col-md-2">
                <label for="enddate">End Date</label>
                <input type="date" class="form-control" id="enddate" name="enddate" value="{{ request.GET.enddate }}">
            </div>

            <!-- Buttons inside the same row -->
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary mx-2">Apply Filters</button>
                <a href="{% url 'arn_tracking_list' %}" class="btn btn-secondary mx-2">Clear Filters</a>
            </div>
        </div>
    </form>


    <!-- Table of ARN Records -->
    <table id="arnTable" class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>SL No</th>
                <th>Trade Name</th>
                <th>ARN Number</th>
                <th>Current Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for arn in arn_records %}
            <tr>
                <td>{{ arn.sl_no }}</td>
                <td>{{ arn.trade_name }}</td>
                <td>{{ arn.arn_number }}</td>
                <td id="status-{{ arn.arn_number }}">{{ arn.current_status }}</td>
                <td>
                     <a href="#" class="fas fa-eye" style="cursor: pointer;"
                   data-bs-toggle="modal"
                   data-bs-target="#arnModal"
                   onclick="populateModal({
                       sl_no: '{{ arn.sl_no }}',
                       trade_name: '{{ arn.trade_name }}',
                       arn_number: '{{ arn.arn_number }}',
                       gstn: '{{ arn.gstn }}',
                       purpose: '{{ arn.purpose }}',
                       dated: '{{ arn.dated }}',
                       assigned_to: '{{ arn.assigned_to }}',
                       reply_due_date: '{{ arn.reply_due_date }}',
                       current_status: '{{ arn.current_status }}'
                   })"
                   title="View Details"
                   aria-label="View ARN Details">
                </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal for Viewing and Updating ARN Details -->
<div class="modal fade" id="arnModal" tabindex="-1" aria-labelledby="arnModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="arnModalLabel">ARN Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>SL No:</strong> <span id="modal-sl_no"></span></p>
                <p><strong>Trade Name:</strong> <span id="modal-trade_name"></span></p>
                <p><strong>ARN Number:</strong> <span id="modal-arn_number"></span></p>
                <p><strong>GSTN:</strong> <span id="modal-gstn"></span></p>
                <p><strong>Purpose:</strong> <span id="modal-purpose"></span></p>
                <p><strong>Dated:</strong> <span id="modal-dated"></span></p>
                <p><strong>Assigned To:</strong> <span id="modal-assigned_to"></span></p>
                <p><strong>Reply Due Date:</strong> <span id="modal-reply_due_date"></span></p>
                <p><strong>Current Status:</strong> <span id="modal-current_status"></span></p>

                <h5>Update Status:</h5>
                <div class="form-group status-buttons">
                    <button class="btn btn-success" onclick="setSelectedStatus('Approved')">Approve</button>
                    <button class="btn btn-info" onclick="setSelectedStatus('Progressing')">Progressing</button>
                    <button class="btn btn-warning" onclick="setSelectedStatus('Pending')">Pending</button>
                    <button class="btn btn-danger" onclick="setSelectedStatus('Rejected')">Reject</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="updateStatus()">Update Status</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
let currentArnNumber = '';
let selectedStatus = '';

function populateModal(data) {
    const {
        sl_no,
        trade_name,
        arn_number,
        gstn,
        purpose,
        dated,
        assigned_to,
        reply_due_date,
        current_status
    } = data;

    currentArnNumber = arn_number;
    document.getElementById('modal-sl_no').innerText = sl_no;
    document.getElementById('modal-trade_name').innerText = trade_name;
    document.getElementById('modal-arn_number').innerText = arn_number;
    document.getElementById('modal-gstn').innerText = gstn;
    document.getElementById('modal-purpose').innerText = purpose;
    document.getElementById('modal-dated').innerText = dated;
    document.getElementById('modal-assigned_to').innerText = assigned_to;
    document.getElementById('modal-reply_due_date').innerText = reply_due_date;
    document.getElementById('modal-current_status').innerText = current_status;
}


function setSelectedStatus(status) {
    selectedStatus = status;
}

function updateStatus() {
    if (!selectedStatus) {
        alert('Please select a status before updating.');
        return;
    }
    $.ajax({
        type: 'POST',
        url: '/arn-tracking/',
        data: {
            'arn_number': currentArnNumber,
            'new_status': selectedStatus,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response, status, xhr) {
            if (xhr.status === 200) {
                document.getElementById(`status-${currentArnNumber}`).innerText = selectedStatus;
                document.getElementById('modal-current_status').innerText = selectedStatus;
                alert('Status updated successfully.');
            } else {
                alert('Error: ' + response.message);
            }
        },
        error: function(xhr) {
            console.error('AJAX error:', xhr.responseText);
            alert('An error occurred while changing the status: ' + xhr.responseText);
        }
    });
}
</script>

<script src='{% static "https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" %}'></script>
<script src='{% static "https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.min.js" %}'></script>

{% endblock body %}
